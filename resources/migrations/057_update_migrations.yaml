databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ALL_OBJECTS
  - changeSet:
      id: v57.2025-08-01T10:00:00
      author: qnkhuat
      comment: Add undo/redo change tracking table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: data_edit_undo_chain
      changes:
        - createTable:
            tableName: data_edit_undo_chain
            remarks: Store the state necessary to power undo / redo.
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  remarks: Batch number for grouped changes (global increment)
                  name: batch_num
                  type: int
                  constraints:
                    nullable: false
              - column:
                  remarks: Reference to the table being modified
                  name: table_id
                  type: int
                  constraints:
                    nullable: false
              - column:
                  remarks: PK of the row being modified, potentially composite. Stored as a sorted JSON map.
                  name: row_pk
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  remarks: ID of the user who made the change
                  name: user_id
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: scope
                  type: ${text.type}
                  remarks: Identifies where the changes were made from
                  constraints:
                    nullable: false
              - column:
                  name: undoable
                  type: ${boolean.type}
                  remarks: Identifies whether a change can be undo
                  constraints:
                    nullable: false
                  defaultValue: true
              - column:
                  remarks: Value of the field before the change
                  name: raw_before
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  remarks: Value of the field after the change
                  name: raw_after
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  remarks: Whether this change has been undone
                  name: undone
                  type: ${boolean.type}
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  remarks: The timestamp of when the change was created
                  name: created_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  remarks: The timestamp of when the change was updated
                  name: updated_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false

  - changeSet:
      id: v57.2025-08-01T10:02:00
      author: qnkhuat
      comment: A table for generating atomic sequence numbers
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: sequences
      changes:
        - createTable:
            tableName: sequences
            remarks: A table for generating atomic sequence numbers
            columns:
              - column:
                  name: name
                  type: varchar(50)
                  remarks: The name of the sequence
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: next_val
                  remarks: The next value in this sequence
                  type: bigint
                  constraints:
                    nullable: false

  - changeSet:
      id: v57.2025-08-02T15:55:38
      author: metamben
      comment: Create transform table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: transform
      changes:
        - createTable:
            tableName: transform
            remarks: The main table for Transform entities
            columns:
              - column:
                  name: id
                  remarks: Unique ID
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  remarks: Name
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: ${text.type}
                  remarks: the description of the transform
                  constraints:
                    nullable: true
              - column:
                  name: source
                  remarks: JSON of source
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  name: target
                  remarks: JSON of target
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: char(21)
                  remarks: Random NanoID tag for unique identity.
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  remarks: The timestamp of when the transform was created
                  name: created_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  remarks: The timestamp of when the transform was updated
                  name: updated_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: execution_trigger
                  type: varchar(32)
                  remarks: The type of automatic trigger (e.g., 'global-schedule') or 'none'
                  defaultValue: none
                  constraints:
                    nullable:  false

  - changeSet:
      id: v57.2025-08-03-worker-runs-app-db
      author: eric
      comment: Create worker_run table in app database to track worker execution
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: worker_run
      changes:
        - createTable:
            tableName: worker_run
            remarks: Table to track worker job executions and their status in the app database
            columns:
              - column:
                  name: run_id
                  type: char(21)
                  remarks: 'NanoID identifier for the worker run'
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: work_id
                  type: bigint
                  remarks: 'Identifier for the unit of work (transform, sync, etc.)'
                  constraints:
                    nullable: false
              - column:
                  name: work_type
                  type: varchar(255)
                  remarks: 'Type/category of the worker job'
                  constraints:
                    nullable: false
              - column:
                  name: run_method
                  type: varchar(255)
                  remarks: 'Method used to execute the worker job'
                  constraints:
                    nullable: false
              - column:
                  name: is_local
                  type: boolean
                  remarks: 'Is this run local?'
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(50)
                  remarks: 'Current status of the worker job (running, completed, failed, etc.)'
                  constraints:
                    nullable: false
              - column:
                  name: is_active
                  type: boolean
                  remarks: 'True only for currently running jobs, null for the others'
                  constraints:
                    nullable: true
                    defaultValue: true
              - column:
                  name: start_time
                  type: ${timestamp_type}
                  remarks: 'When the worker job started'
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: end_time
                  type: ${timestamp_type}
                  remarks: 'When the worker job completed (null if still running)'
                  constraints:
                    nullable: true
              - column:
                  name: message
                  type: text
                  remarks: 'Human-readable message about the run; may contain error message in case status is error'
                  constraints:
                    nullable: true


  - changeSet:
      id: v57.2025-08-04T10:53:00
      author: metamben
      comment: Add last run index on worker_run
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: worker_run
                indexName: idx_worker_run_last_run_idx
      changes:
        - createIndex:
            tableName: worker_run
            indexName: idx_worker_run_last_run_idx
            columns:
              - column:
                  name: work_type
              - column:
                  name: work_id
              - column:
                  name: start_time
                  descending: true

  - changeSet:
      id: v57.2025-08-04T10:54:00
      author: metamben
      comment: Add unique index to make sure at most one run can be active
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: worker_run
                indexName: idx_unique_active_worker_run
      changes:
        - addUniqueConstraint:
            tableName: worker_run
            constraintName: idx_unique_active_worker_run
            columnNames: work_type, work_id, is_active

  - changeSet:
      id: v57.2025-08-04T10:55:00
      author: metamben
      comment: Add partial index for querying active runs
      dbms: postgresql
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: worker_run
                indexName: idx_worker_run_active_runs
      changes:
        - createIndex:
            tableName: worker_run
            indexName: idx_worker_run_active_runs
            columns:
              - column:
                  name: work_type
              - column:
                  name: work_id
            where: "is_active = true"

  - changeSet:
      id: v57.2025-08-04T10:55:01
      author: metamben
      comment: Add index for querying active runs
      dbms: mysql, h2
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: worker_run
                indexName: idx_worker_run_active_runs
      changes:
        - createIndex:
            tableName: worker_run
            indexName: idx_worker_run_active_runs
            columns:
              - column:
                  name: is_active
              - column:
                  name: work_type
              - column:
                  name: work_id


  - changeSet:
      id: v57.2025-08-06T13:00:00
      author: escherize
      comment: Create workspace table
      changes:
        - createTable:
            tableName: workspace
            remarks: Workspaces table
            columns:
              - column:
                  name: id
                  remarks: Unique ID
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  remarks: The timestamp of when the document was created
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  remarks: The timestamp of when the document was updated
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              # Json cols:
              - column:
                  name: plans
                  remarks: JSON object containing plans, keyed by path
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  name: transforms
                  remarks: JSON object containing transforms
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  name: activity_logs
                  remarks: JSON object containing activity_logs, keyed by run-id
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  name: permissions
                  remarks: JSON object containing permissions
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  name: users
                  remarks: JSON object containing info about workspace-users
                  type: ${text.type}
                  constraints:
                    nullable: true
              - column:
                  name: data_warehouses
                  remarks: JSON object containing data warehouses
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  name: documents
                  remarks: seq of document ids linked to this workspace
                  type: ${text.type}
                  constraints:
                    nullable: false
              - column:
                  name: collection_id
                  type: int
                  remarks: The collection containing the workspace
                  constraints:
                    nullable: false
                    referencedTableName: collection
                    referencedColumnNames: id
                    foreignKeyName: fk_workspace_ref_collection_id
                    deleteCascade: true


# >>>>>>>>>> DO NOT ADD NEW MIGRATIONS BELOW THIS LINE! ADD THEM ABOVE <<<<<<<<<<

########################################################################################################################
#
# ADVICE:
#
# 1) Think through some of these points when writing a migration, learn from our past mistakes:
#    - Do you really need a migration? Could the feature work without it? Prefer not to if possible.
#      Data in the wild can be vastly different from what you expect, and it's hard to get right.
#    - Make sure your migration is backward compatible: it might not be possible to add a constraint back
#      if you drop it in a migration.
#    - Postgres, MySQL and H2 have their differences. Make sure your migration works for all.
#    - Database encryption is a major issue:
#      - Fields like `metabase_database.details` or `setting.value` can be encrypted, so you need to decrypt them in
#        your migration. See #42617, #44048.
#      - Database could be partially encrypted, see https://www.notion.so/72575933ef2a446bafd16909e05a7387
#    - Custom migrations:
#      - Prefer SQL migrations when possible.
#      - Never use application code: it can change and *will* break your migration.
#      - Do not use Toucan models - refer table names directly.
#      - If it's a big change, consider using Quartz, see #42279
#      - More in `metabase.app_db.custom_migrations` namespace doc.
#    - Never delete a migration: users won't be able to downgrade. If you really need to, see #44908
#    - Migration id (`vXX.<date>`) must match its earliest released version:
#      - Do not backport `v51....` to version 50, Metabase will try to downgrade it.
#      - Instead, write a migration with an oldest target you plan to backport to in mind.
#
# 2) Migrations should go in the ###_update_migrations.yaml file for the target version.
#
# 3) Run mage lint-migrations-file to run core.spec checks against any changes you make here. Liquibase is pretty
#    forgiving and won't complain if you accidentally mix up things like deleteCascade and onDelete: CASCADE. CI runs
#    this check but it's nicer to know now instead of waiting for CI.
#
# 3) Migration IDs should follow the format
#
#    vMM.TIMESTAMP
#
#    Where
#
#    M         = major version
#    TIMESTAMP = the current timestamp with format `yyyy-MM-dd'T'HH:mm:ss`
#                To get this timestamp, evaluate this in your REPL: `(dev/migration-timestamp)`
#
#    E.g: You're adding a new migration for version 49, And it's 10:30:00AM on April 1, 2023 (UTC),
#    your migration id should be: `v49.2023-04-01T10:30:00`.
#
# PLEASE KEEP THIS MESSAGE AT THE BOTTOM OF THIS FILE!!!!! Add new migrations above the message.
#
########################################################################################################################
